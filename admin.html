<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex, nofollow" />
    <title>Analytics Dashboard • ryduzz</title>
    <style>
      :root {
        --bg: radial-gradient(120% 120% at 10% 10%, #1a2333 0%, #0b0d13 45%, #05060b 100%);
        --card: rgba(17, 22, 33, 0.85);
        --card-border: rgba(255, 255, 255, 0.08);
        --text: #f4f7ff;
        --muted: #9aa3ba;
        --accent: #4f8cff;
        --accent-soft: rgba(79, 140, 255, 0.16);
        --danger: #ff6b6b;
        --radius: 18px;
        --shadow: 0 24px 60px rgba(3, 7, 18, 0.5);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: var(--bg);
        color: var(--text);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI',
          Roboto, sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 48px 16px;
      }

      .layout {
        width: min(1100px, 100%);
        display: flex;
        flex-direction: column;
        gap: 28px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--card-border);
        border-radius: var(--radius);
        padding: 32px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(18px);
      }

      h1,
      h2 {
        margin: 0;
        font-weight: 600;
        letter-spacing: 0.02em;
      }

      h1 {
        font-size: clamp(26px, 3vw, 36px);
      }

      h2 {
        font-size: 20px;
      }

      p {
        margin: 8px 0 0;
        line-height: 1.6;
      }

      .muted {
        color: var(--muted);
      }

      .small {
        font-size: 13px;
      }

      form {
        margin-top: 24px;
        display: grid;
        gap: 16px;
      }

      label {
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
      }

      input[type='password'] {
        padding: 12px 14px;
        border-radius: 14px;
        border: 1px solid var(--card-border);
        background: rgba(255, 255, 255, 0.05);
        color: var(--text);
        font: inherit;
      }

      input[type='password']:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-soft);
      }

      button {
        font: inherit;
        border: none;
        border-radius: 14px;
        padding: 12px 18px;
        cursor: pointer;
        transition: transform 0.2s ease, filter 0.2s ease;
      }

      button.primary {
        background: linear-gradient(135deg, #4f8cff, #6a5bff);
        color: #fff;
        font-weight: 600;
      }

      button.primary:hover {
        transform: translateY(-1px);
        filter: brightness(1.08);
      }

      button.ghost {
        background: transparent;
        color: var(--text);
        border: 1px solid rgba(255, 255, 255, 0.18);
      }

      button.ghost:hover {
        transform: translateY(-1px);
        filter: brightness(1.12);
      }

      button.danger {
        background: var(--danger);
        color: #fff;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .error-message {
        min-height: 20px;
        color: var(--danger);
        font-size: 14px;
      }

      .hidden {
        display: none !important;
      }

      .dashboard-header {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        justify-content: space-between;
        align-items: flex-start;
      }

      .actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 18px;
        margin: 28px 0 12px;
      }

      .metric {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 18px;
      }

      .metric-label {
        font-size: 13px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--muted);
      }

      .metric-value {
        font-size: 32px;
        font-weight: 600;
        margin-top: 6px;
      }

      .metric-sub {
        font-size: 13px;
        color: var(--muted);
        margin-top: 6px;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 24px;
      }

      .panel {
        background: rgba(10, 14, 22, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 20px;
      }

      .panel h2 {
        margin-bottom: 12px;
        font-size: 18px;
      }

      .table-wrapper {
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 360px;
      }

      th,
      td {
        padding: 10px 12px;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        font-size: 14px;
      }

      th {
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: var(--muted);
        font-size: 12px;
      }

      tbody tr:last-child td {
        border-bottom: none;
      }

      .table-title {
        font-weight: 600;
      }

      .table-sub {
        font-size: 12px;
        color: var(--muted);
      }

      .activity-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 12px;
      }

      .activity-list li {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 14px;
        padding: 12px 14px;
        font-size: 14px;
      }

      .activity-list strong {
        display: block;
        font-size: 15px;
      }

      .activity-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 6px;
        color: var(--muted);
        font-size: 12px;
      }

      .list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 10px;
      }

      .list li {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        font-size: 14px;
      }

      .list li span:last-child {
        color: var(--muted);
      }

      .empty {
        color: var(--muted);
        text-align: center;
        padding: 12px 0;
      }

      details {
        margin-top: 28px;
      }

      details summary {
        cursor: pointer;
        color: #7fa4ff;
        font-weight: 500;
        outline: none;
      }

      details[open] summary {
        margin-bottom: 12px;
      }

      .code-block {
        background: rgba(5, 7, 16, 0.85);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 16px;
        color: #cdd4ec;
        font-size: 13px;
        line-height: 1.5;
        max-height: 320px;
        overflow: auto;
      }

      @media (max-width: 720px) {
        body {
          padding: 32px 12px;
        }

        .card {
          padding: 24px;
        }

        .dashboard-header {
          flex-direction: column;
          align-items: stretch;
        }

        .actions {
          justify-content: flex-start;
        }

        table {
          min-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <main class="layout">
      <section id="auth-card" class="card">
        <h1>Admin Access</h1>
        <p class="muted">
          This dashboard surfaces visits and click interactions captured on the
          site. Enter the administrator password to continue.
        </p>
        <form id="auth-form">
          <div>
            <label for="admin-password">Password</label>
            <input
              type="password"
              id="admin-password"
              name="admin-password"
              autocomplete="current-password"
              required
              aria-required="true"
            />
          </div>
          <button type="submit" class="primary" id="unlock-button">
            Unlock Dashboard
          </button>
          <p id="auth-error" class="error-message" role="alert" aria-live="polite"></p>
        </form>
      </section>

      <section id="dashboard" class="card hidden" aria-live="polite">
        <div class="dashboard-header">
          <div>
            <h1>Analytics Dashboard</h1>
            <p class="muted">
              Data is stored locally on each visitor's browser via
              <code>localStorage</code>. Clearing the dashboard only removes the
              copy saved on this device.
            </p>
            <p class="muted small">Last updated <span id="last-updated">—</span></p>
          </div>
          <div class="actions">
            <button type="button" class="ghost" id="refresh-dashboard">
              Refresh
            </button>
            <button type="button" id="export-data">Export JSON</button>
            <button type="button" class="danger" id="clear-data">
              Clear Data
            </button>
          </div>
        </div>
        <div id="dashboard-content"></div>
        <details class="raw-dump">
          <summary>View raw analytics payload</summary>
          <pre id="raw-json" class="code-block"></pre>
        </details>
      </section>
    </main>

    <script src="analytics.js"></script>
    <script>
      (function () {
        const PASSWORD_HASH =
          '1a6de28170fde72e6e3202ff218411232698541a8b677c00de3ddc12e4787b06';
        const AUTH_KEY = 'ryduzz::admin:auth';

        const authCard = document.getElementById('auth-card');
        const dashboard = document.getElementById('dashboard');
        const form = document.getElementById('auth-form');
        const passwordInput = document.getElementById('admin-password');
        const unlockButton = document.getElementById('unlock-button');
        const errorEl = document.getElementById('auth-error');
        const lastUpdatedEl = document.getElementById('last-updated');
        const contentEl = document.getElementById('dashboard-content');
        const rawEl = document.getElementById('raw-json');
        const refreshBtn = document.getElementById('refresh-dashboard');
        const exportBtn = document.getElementById('export-data');
        const clearBtn = document.getElementById('clear-data');

        const numberFormatter = new Intl.NumberFormat();

        function formatNumber(value) {
          return numberFormatter.format(Math.max(0, Math.round(value || 0)));
        }

        function formatFloat(value, decimals = 2) {
          return Number.isFinite(value)
            ? Number(value).toFixed(decimals)
            : (0).toFixed(decimals);
        }

        function escapeHTML(value) {
          if (value === null || value === undefined) return '';
          return String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
        }

        function formatDateTime(iso) {
          if (!iso) return '—';
          const date = new Date(iso);
          if (Number.isNaN(date.getTime())) return '—';
          try {
            return new Intl.DateTimeFormat(undefined, {
              dateStyle: 'medium',
              timeStyle: 'short',
            }).format(date);
          } catch (err) {
            return date.toLocaleString();
          }
        }

        function simplifyAgent(agent) {
          if (!agent) return 'Unknown';
          const ua = agent.toLowerCase();
          if (ua.includes('edg/')) return 'Microsoft Edge';
          if (ua.includes('opr/') || ua.includes('opera')) return 'Opera';
          if (ua.includes('firefox')) return 'Firefox';
          if (ua.includes('iphone') || ua.includes('ipad')) return 'Safari (iOS)';
          if (ua.includes('android') && ua.includes('chrome'))
            return 'Chrome (Android)';
          if (ua.includes('android')) return 'Android Browser';
          if (ua.includes('safari') && !ua.includes('chrome')) return 'Safari';
          if (ua.includes('chrome')) return 'Chrome';
          if (ua.includes('windows')) return 'Windows';
          if (ua.includes('mac os')) return 'macOS';
          if (ua.includes('linux')) return 'Linux';
          return agent.split('(')[0].trim() || 'Other';
        }

        async function hashPassword(value) {
          const encoder = new TextEncoder();
          const data = encoder.encode(value);
          const hashBuffer = await crypto.subtle.digest('SHA-256', data);
          const hashArray = Array.from(new Uint8Array(hashBuffer));
          return hashArray.map((b) => b.toString(16).padStart(2, '0')).join('');
        }

        function storeAuth() {
          try {
            sessionStorage.setItem(AUTH_KEY, PASSWORD_HASH);
          } catch (err) {
            console.warn('Unable to persist admin session.', err);
          }
        }

        function hasAuth() {
          try {
            return sessionStorage.getItem(AUTH_KEY) === PASSWORD_HASH;
          } catch (err) {
            return false;
          }
        }

        function showDashboard() {
          authCard.classList.add('hidden');
          dashboard.classList.remove('hidden');
          renderDashboard();
        }

        function showError(message) {
          errorEl.textContent = message;
        }

        async function handleSubmit(event) {
          event.preventDefault();
          showError('');
          const password = passwordInput.value.trim();
          if (!password) {
            showError('Please enter the administrator password.');
            return;
          }
          unlockButton.disabled = true;
          unlockButton.textContent = 'Verifying…';
          try {
            const hash = await hashPassword(password);
            if (hash === PASSWORD_HASH) {
              storeAuth();
              passwordInput.value = '';
              showDashboard();
            } else {
              showError('Incorrect password. Please try again.');
              passwordInput.focus();
              passwordInput.select();
            }
          } catch (err) {
            console.error('Authentication error', err);
            showError('Authentication failed. Please try again.');
          } finally {
            unlockButton.disabled = false;
            unlockButton.textContent = 'Unlock Dashboard';
          }
        }

        function aggregateReferrers(pages) {
          const totals = {};
          pages.forEach((page) => {
            const refs = page.referrers || {};
            Object.entries(refs).forEach(([key, value]) => {
              const name = key || 'Direct / None';
              totals[name] = (totals[name] || 0) + Number(value || 0);
            });
          });
          return Object.entries(totals)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 6);
        }

        function aggregateDevices(visits) {
          const devices = {};
          visits.forEach((visit) => {
            const name = simplifyAgent(visit.userAgent);
            devices[name] = (devices[name] || 0) + 1;
          });
          return Object.entries(devices)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 6);
        }

        function renderDashboard() {
          if (!window.SiteAnalytics) {
            contentEl.innerHTML =
              '<p class="muted">Analytics module unavailable. Ensure analytics.js is loaded.</p>';
            rawEl.textContent = '';
            lastUpdatedEl.textContent = 'Unavailable';
            return;
          }

          const data = window.SiteAnalytics.getData();
          const totalVisits = data.totals?.visits || 0;
          const totalClicks = data.totals?.clicks || 0;
          const uniqueVisitors = Object.keys(data.visitors || {}).length;
          const pageEntries = Object.entries(data.pages || {}).map(([path, page]) => ({
            path,
            title: page.title || path,
            visits: Number(page.visits) || 0,
            uniqueVisitors:
              typeof page.uniqueVisitors === 'number'
                ? page.uniqueVisitors
                : Object.keys(page.visitors || {}).length,
            clicks: Number(page.clicks) || 0,
            lastVisit: page.lastVisit || null,
            referrers: page.referrers || {},
          }));
          pageEntries.sort((a, b) => b.visits - a.visits);

          const clickEntries = Object.entries(data.clicks || {}).map(
            ([label, info]) => {
              const pages = Object.entries(info.pages || {}).sort(
                (a, b) => b[1] - a[1],
              );
              return {
                label,
                count: Number(info.count) || 0,
                uniqueVisitors:
                  typeof info.uniqueVisitors === 'number'
                    ? info.uniqueVisitors
                    : Object.keys(info.visitors || {}).length,
                lastTimestamp: info.lastTimestamp || null,
                topPage: pages.length ? pages[0][0] : null,
              };
            },
          );
          clickEntries.sort((a, b) => b.count - a.count);

          const recentVisits = (data.visits || []).slice(-8).reverse();
          const recentClicks = (data.clickEvents || []).slice(-8).reverse();
          const referrers = aggregateReferrers(pageEntries);
          const devices = aggregateDevices(data.visits || []);

          const avgVisitsPerVisitor = uniqueVisitors
            ? totalVisits / uniqueVisitors
            : 0;
          const avgClicksPerVisit = totalVisits ? totalClicks / totalVisits : 0;
          const clickThrough = totalVisits ? (totalClicks / totalVisits) * 100 : 0;

          lastUpdatedEl.textContent = formatDateTime(data.lastUpdated);

          const pageRows = pageEntries.length
          ? pageEntries
              .slice(0, 6)
              .map(
                (page) => `
              <tr>
                <td>
                  <div class="table-title">${escapeHTML(page.title)}</div>
                  <div class="table-sub">${escapeHTML(page.path)}</div>
                </td>
                <td>${formatNumber(page.visits)}</td>
                <td>${formatNumber(page.uniqueVisitors)}</td>
                <td>${formatNumber(page.clicks)}</td>
                <td>${formatDateTime(page.lastVisit)}</td>
              </tr>
            `,
              )
              .join('')
          : '<tr><td class="empty" colspan="5">No visits recorded yet.</td></tr>';

        const clickRows = clickEntries.length
          ? clickEntries
              .slice(0, 8)
              .map(
                (entry) => `
              <tr>
                <td>${escapeHTML(entry.label)}</td>
                <td>${formatNumber(entry.count)}</td>
                <td>${formatNumber(entry.uniqueVisitors)}</td>
                <td>${entry.topPage ? escapeHTML(entry.topPage) : '—'}</td>
                <td>${formatDateTime(entry.lastTimestamp)}</td>
              </tr>
            `,
              )
              .join('')
          : '<tr><td class="empty" colspan="5">No click interactions captured yet.</td></tr>';

        const visitItems = recentVisits.length
          ? recentVisits
              .map((visit) => {
                const ref = visit.referrer
                  ? visit.referrer === 'Direct'
                    ? 'Direct / None'
                    : visit.referrer
                  : 'Direct / None';
                return `
              <li>
                <strong>${escapeHTML(visit.title || visit.path)}</strong>
                <div class="table-sub">${escapeHTML(visit.path)}</div>
                <div class="activity-meta">
                  <span>${formatDateTime(visit.timestamp)}</span>
                  <span>${escapeHTML(ref)}</span>
                  ${visit.language ? `<span>${escapeHTML(visit.language)}</span>` : ''}
                </div>
              </li>
            `;
              })
              .join('')
          : '<li class="empty">No visits logged yet.</li>';

        const clickItems = recentClicks.length
          ? recentClicks
              .map((click) => `
              <li>
                <strong>${escapeHTML(click.label)}</strong>
                <div class="table-sub">${escapeHTML(click.path)}</div>
                <div class="activity-meta">
                  <span>${formatDateTime(click.timestamp)}</span>
                  ${click.href ? `<span>${escapeHTML(click.href)}</span>` : ''}
                </div>
              </li>
            `)
              .join('')
          : '<li class="empty">No click activity logged yet.</li>';

        const referrerItems = referrers.length
          ? referrers
              .map(
                ([name, count]) => `
              <li>
                <span>${escapeHTML(name)}</span>
                <span>${formatNumber(count)}</span>
              </li>
            `,
              )
              .join('')
          : '<li class="empty">No referrer data yet.</li>';

        const deviceItems = devices.length
          ? devices
              .map(
                ([name, count]) => `
              <li>
                <span>${escapeHTML(name)}</span>
                <span>${formatNumber(count)}</span>
              </li>
            `,
              )
              .join('')
          : '<li class="empty">No device data yet.</li>';

        contentEl.innerHTML = `
          <div class="metrics-grid">
            <div class="metric">
              <div class="metric-label">Total Visits</div>
              <div class="metric-value">${formatNumber(totalVisits)}</div>
              <div class="metric-sub">Unique visitors: ${formatNumber(
                uniqueVisitors,
              )}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Total Clicks</div>
              <div class="metric-value">${formatNumber(totalClicks)}</div>
              <div class="metric-sub">Avg per visit: ${formatFloat(
                avgClicksPerVisit,
              )}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Click-through Rate</div>
              <div class="metric-value">${formatFloat(clickThrough, 1)}%</div>
              <div class="metric-sub">Clicks ÷ visits</div>
            </div>
            <div class="metric">
              <div class="metric-label">Tracked Pages</div>
              <div class="metric-value">${formatNumber(pageEntries.length)}</div>
              <div class="metric-sub">Average visits per visitor: ${formatFloat(
                avgVisitsPerVisitor,
              )}</div>
            </div>
          </div>
          <div class="dashboard-grid">
            <div class="panel">
              <h2>Top Pages</h2>
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>Page</th>
                      <th>Visits</th>
                      <th>Unique</th>
                      <th>Clicks</th>
                      <th>Last visit</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${pageRows}
                  </tbody>
                </table>
              </div>
            </div>
            <div class="panel">
              <h2>Top Click Targets</h2>
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>Label</th>
                      <th>Clicks</th>
                      <th>Unique</th>
                      <th>Top page</th>
                      <th>Last</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${clickRows}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="dashboard-grid">
            <div class="panel">
              <h2>Recent Visits</h2>
              <ul class="activity-list">${visitItems}</ul>
            </div>
            <div class="panel">
              <h2>Recent Clicks</h2>
              <ul class="activity-list">${clickItems}</ul>
            </div>
          </div>
          <div class="dashboard-grid">
            <div class="panel">
              <h2>Top Referrers</h2>
              <ul class="list">${referrerItems}</ul>
            </div>
            <div class="panel">
              <h2>Top Devices / Agents</h2>
              <ul class="list">${deviceItems}</ul>
            </div>
          </div>
        `;

        rawEl.textContent = JSON.stringify(data, null, 2);
      }

      refreshBtn.addEventListener('click', () => {
        renderDashboard();
      });

      exportBtn.addEventListener('click', () => {
        if (!window.SiteAnalytics) return;
        const data = window.SiteAnalytics.exportData();
        const blob = new Blob([JSON.stringify(data, null, 2)], {
          type: 'application/json',
        });
        const stamp = new Date()
          .toISOString()
          .replace(/[:.]/g, '-')
          .slice(0, 19);
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ryduzz-analytics-${stamp}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(url), 500);
      });

      clearBtn.addEventListener('click', () => {
        if (!window.SiteAnalytics) return;
        const confirmed = window.confirm(
          'Clear all locally stored analytics data for this device? This action cannot be undone.',
        );
        if (!confirmed) return;
        window.SiteAnalytics.clearData();
        renderDashboard();
      });

      form.addEventListener('submit', handleSubmit);

      if (hasAuth()) {
        showDashboard();
      } else {
        passwordInput.focus();
      }
    })();
    </script>
  </body>
</html>
